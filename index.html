import asyncio
from web3 import Web3
from datetime import datetime, timedelta
import requests
import json
from collections import defaultdict

# 配置Ink区块链的RPC端点和API密钥
INK_RPC_URL = "https://rpc.inkonchain.com"  # 替换为实际的Ink RPC端点
INK_EXPLORER_API = "https://api.inkonchain.com/api"  # 替换为实际的Ink区块链浏览器API
API_KEY = "YOUR_INK_EXPLORER_API_KEY"  # 替换为你的API密钥

# 初始化Web3
web3 = Web3(Web3.HTTPProvider(INK_RPC_URL))

# 检查连接
def check_connection():
    if not web3.is_connected():
        raise Exception("无法连接到Ink区块链节点")
    print("已连接到Ink区块链")

# 获取账户的交易数据
def get_account_transactions(account_address, start_block=0, end_block='latest'):
    params = {
        'module': 'account',
        'action': 'txlist',
        'address': account_address,
        'startblock': start_block,
        'endblock': end_block,
        'sort': 'asc',
        'apikey': API_KEY
    }
    response = requests.get(INK_EXPLORER_API, params=params)
    data = response.json()
    
    if data['status'] == '1':
        return data['result']
    else:
        raise Exception(f"API错误: {data['message']}")

# 分析交易数据
def analyze_transactions(transactions):
    interaction_count = 0
    interaction_days = set()
    interaction_weeks = set()
    interaction_months = set()
    total_amount = 0
    unique_contracts = set()

    for tx in transactions:
        # 增加交互次数
        interaction_count += 1
        
        # 获取交易时间
        timestamp = int(tx['timeStamp'])
        tx_date = datetime.fromtimestamp(timestamp)
        
        # 记录交互的日期、周、月
        interaction_days.add(tx_date.date())
        interaction_weeks.add((tx_date.year, tx_date.isocalendar()[1]))
        interaction_months.add((tx_date.year, tx_date.month))
        
        # 累加交易金额（以wei为单位）
        total_amount += int(tx['value'])
        
        # 记录不同的合约地址
        if tx.get('to') and web3.eth.get_code(tx['to']).hex() != '0x':
            unique_contracts.add(tx['to'])
    
    return {
        'interaction_count': interaction_count,
        'interaction_days': len(interaction_days),
        'interaction_weeks': len(interaction_weeks),
        'interaction_months': len(interaction_months),
        'total_amount_ether': web3.from_wei(total_amount, 'ether'),
        'unique_contracts': len(unique_contracts)
    }

async def main():
    try:
        # 检查连接
        check_connection()
        
        # 要查询的账户地址
        account_address = input("请输入Ink账户地址: ")
        
        # 验证地址格式
        if not web3.is_address(account_address):
            raise Exception("无效的账户地址")
        
        # 获取交易数据
        print("正在获取交易数据...")
        transactions = get_account_transactions(account_address)
        
        # 分析交易数据
        result = analyze_transactions(transactions)
        
        # 输出结果
        print("\n账户分析结果:")
        print(f"交互次数: {result['interaction_count']}")
        print(f"交互天数: {result['interaction_days']}")
        print(f"交互周数: {result['interaction_weeks']}")
        print(f"交互月数: {result['interaction_months']}")
        print(f"总交易金额: {result['total_amount_ether']} ETH")
        print(f"不同合约数: {result['unique_contracts']}")
        
    except Exception as e:
        print(f"错误: {str(e)}")

if __name__ == "__main__":
    asyncio.run(main())
