const contractAddress = '0x060152dBBEAA5e94D911b5Cc37347e2951f0A06D';
const abi = [
    // 这里填入你的合约 ABI
    // 例如：
    {
        "constant": false,
        "inputs": [],
        "name": "claimTokens",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [{"name": "user", "type": "address"}],
        "name": "isWhitelisted",
        "outputs": [{"name": "", "type": "bool"}],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    }
];

let web3;
let contract;
let userAddress;

document.getElementById('connectWallet').addEventListener('click', connectWallet);
document.getElementById('claimTokens').addEventListener('click', claimTokens);

async function connectWallet() {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            const accounts = await web3.eth.getAccounts();
            userAddress = accounts[0];
            document.getElementById('status').innerText = `Connected: ${userAddress}`;
            checkWhitelist(userAddress);
        } catch (error) {
            console.error("User denied account access or error occurred", error);
        }
    } else {
        console.error("MetaMask not detected");
    }
}

async function checkWhitelist(address) {
    contract = new web3.eth.Contract(abi, contractAddress);
    const isWhitelisted = await contract.methods.isWhitelisted(address).call();
    if (isWhitelisted) {
        document.getElementById('claimTokens').disabled = false;
        document.getElementById('status').innerText = 'You are whitelisted! Click to claim tokens.';
    } else {
        document.getElementById('status').innerText = 'You are not whitelisted.';
    }
}

async function claimTokens() {
    try {
        await contract.methods.claimTokens().send({ from: userAddress });
        document.getElementById('status').innerText = 'Tokens claimed successfully!';
    } catch (error) {
        console.error("Error claiming tokens", error);
        document.getElementById('status').innerText = 'Error claiming tokens.';
    }
}
